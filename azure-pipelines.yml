# Starter pipeline

trigger:
  branches:
    include:
    - '*'

pool:
  vmImage: 'ubuntu-18.04'

stages:
  - stage: build
    displayName: 'Build'

    jobs:

      - job: build
        displayName: 'Build'
        steps:

        - task: Docker@2
          inputs:
            containerRegistry: 'gcrServiceConnection'
            repository: 'gcp-cf-272812/go-microservice'
            command: 'buildAndPush'
            Dockerfile: '**/Dockerfile'
            tags: '$(Build.SourceVersion)'

  - stage: dev
    displayName: 'Development'

    jobs:

      - job: package
        displayName: "Helm Package"
        steps:

        - task: HelmDeploy@0
          inputs:
            command: 'package'
            chartPath: './chart'
            destination: $(Build.ArtifactStagingDirectory)
            save: false

      - deployment: deploy
        displayName: 'Deploy Helm Chart'

        environment: dev.default

        strategy:
          runOnce:
            deploy:
              steps:

                - script: echo 'Deploy here...'
                # - task: HelmDeploy@0
                #   inputs:
                #     connectionType: 'Kubernetes Service Connection'
                #     kubernetesServiceConnection: 'dev-default-1589456418781'
                #     namespace: $(k8sNamespace)
                #     command: 'install'
                #     overrideValues: blue.image=$(Build.SourceVersion),blue.pullPolicy=IfNotPresent,green.image=$(Build.SourceVersion),green.pullPolicy=IfNotPresent
                #     chartType: 'FilePath'
                #     chartPath: 'chart/'
                #     chartName: 'go-microservice'

                # - task: Kubernetes@1
                #   inputs:

                #     namespace: $(k8sNamespace)
                #     command: 'get'
                #     arguments: 'namespaces'
